<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Email Ticket System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>

<body class="bg-light">
    <div class="text-center mb-4">
        <h4 id="connection-status" class="text-muted">Checking database connection...</h4>
        <h4 id="get-connection-status" class="text-muted">GET Connection: Checking...</h4>
        <h4 id="post-connection-status" class="text-muted">POST Connection: Not yet tested</h4>
    </div>

    <div id="root"></div>
    <div class="container mt-5">
        <h1 class="text-center mb-4">IT Email Ticket System</h1>
        <form id="workOrderForm" class="card shadow p-4 mb-4">
            <fieldset>
                <legend class="mb-3">Work Order Information</legend>

                <!-- Customer and Account Information -->
                <div class="mb-3">
                    <label for="customer-name" class="form-label">Customer Name:</label>
                    <input type="text" id="customer-name" name="customer_name" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label for="account-number" class="form-label">Account Number:</label>
                    <input type="text" id="account-number" name="account_number" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label for="store-address" class="form-label">Store Address:</label>
                    <textarea id="store-address" name="store_address" rows="3" class="form-control" required></textarea>
                </div>

                <!-- Work Request Details -->
                <div class="mb-3">
                    <label for="work-request" class="form-label">Work Requested:</label>
                    <textarea id="work-request" name="work_requested" rows="5" class="form-control" required></textarea>
                </div>

                <!-- Contact Information -->
                <div class="mb-3">
                    <label for="contact-name" class="form-label">Store Contact Name:</label>
                    <input type="text" id="contact-name" name="store_contact_name" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label for="contact-phone" class="form-label">Store Contact Phone:</label>
                    <input type="tel" id="contact-phone" name="store_contact_phone" class="form-control" required>
                </div>

                <!-- Work Performed -->
                <div class="mb-3">
                    <label for="work-performed" class="form-label">Work Performed:</label>
                    <textarea id="work-performed" name="work_performed" rows="5" class="form-control"></textarea>
                </div>
            </fieldset>

            <button type="button" class="btn btn-primary w-100" id="saveButton">Save Work Order</button>
        </form>

        <!-- Combined Section to display Saved Work Orders and IT Tickets -->
        <div id="combinedSection" class="card shadow p-4 mt-4">
            <h2>Work Orders and IT Tickets</h2>
            <div class="table-responsive">
                <table id="combinedTable" class="table table-striped table-dark">
                    <thead>
                        <tr>
                            <th scope="col">Source</th>
                            <th scope="col">Customer Name</th>
                            <th scope="col">Account Number</th>
                            <th scope="col">Work Requested</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be dynamically added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Function to update and log connection statuses
        function updateConnectionStatus(type, status) {
            const statusElement = document.getElementById(`${type}-connection-status`);
            if (status === "Good") {
                statusElement.textContent = `${type.toUpperCase()} Connection: Good`;
                statusElement.className = "text-success";
            } else {
                statusElement.textContent = `${type.toUpperCase()} Connection: Bad`;
                statusElement.className = "text-danger";
            }
            console.log(`${type.toUpperCase()} Connection Status: ${status}`);
        }

        // Function to fetch IT tickets from the backend
        async function fetchTickets() {
            try {
                const response = await fetch('http://127.0.0.1:8000/api/it_ticket/list-tickets/', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                });

                if (response.ok) {
                    const tickets = await response.json();
                    updateConnectionStatus("get", "Good");
                    console.log("GET request succeeded.", tickets);
                    displayCombinedTable(tickets, "Database"); // Add tickets to combined table
                } else {
                    updateConnectionStatus("get", "Bad");
                    console.error("GET request failed with status:", response.status);
                }
            } catch (error) {
                updateConnectionStatus("get", "Bad");
                console.error("GET request error:", error);
            }
        }

        // Function to save a work order
        async function saveWorkOrder() {
            const form = document.getElementById("workOrderForm");
            const formData = new FormData(form);
            const workOrderData = {};

            // Convert form data to JSON
            formData.forEach((value, key) => {
                workOrderData[key] = value.trim();
            });

            // Add unique key
            const uniqueKey = `key-${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;
            workOrderData.uniqueKey = uniqueKey;

            // Save to localStorage
            localStorage.setItem(uniqueKey, JSON.stringify(workOrderData));
            console.log(`Saved locally: ${uniqueKey}`, workOrderData);

            // Add to combined table as Local Storage
            displayCombinedTable([workOrderData], "Local Storage");

            // Attempt to send to the backend
            try {
                const response = await fetch('http://127.0.0.1:8000/api/it_ticket/create-ticket/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(workOrderData),
                });

                if (response.ok) {
                    const result = await response.json();
                    alert("Work order saved successfully!");
                    updateConnectionStatus("post", "Good");
                    console.log("POST request succeeded:", result);
                } else {
                    const errorData = await response.json();
                    alert("Failed to save work order to the backend.");
                    updateConnectionStatus("post", "Bad");
                    console.error("POST request failed:", errorData);
                }
            } catch (error) {
                updateConnectionStatus("post", "Bad");
                console.error("POST request error:", error);
            }

            // Reset the form
            form.reset();
        }

        // Function to display combined table of work orders and IT tickets
        function displayCombinedTable(items, source) {
            const combinedTableBody = document.querySelector("#combinedTable tbody");

            items.forEach(item => {
                const row = document.createElement("tr");

                row.innerHTML = `
                    <td>${source}</td>
                    <td>${item.customer_name || "N/A"}</td>
                    <td>${item.account_number || "N/A"}</td>
                    <td>${item.work_requested || "N/A"}</td>
                `;

                combinedTableBody.appendChild(row);
            });
        }

        // Function to load saved work orders from localStorage
        function loadSavedWorkOrders() {
            const savedWorkOrders = [];

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const data = JSON.parse(localStorage.getItem(key));
                savedWorkOrders.push(data);
            }

            displayCombinedTable(savedWorkOrders, "Local Storage");
        }

        // Initialize connection checks and event listeners
        window.onload = () => {
            fetchTickets(); // Fetch tickets and test GET connection
            loadSavedWorkOrders(); // Load saved work orders from localStorage
        };

        document.getElementById("saveButton").addEventListener("click", (event) => {
            event.preventDefault();
            saveWorkOrder(); // Save work order on button click
        });
    </script>
</body>

</html>