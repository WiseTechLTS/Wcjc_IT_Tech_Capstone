<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Link Login</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Center the container vertically and horizontally */
        body, html {
            height: 100%;
        }
        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }
    </style>
</head>

<body class="bg-light">
    <main class="container">
        <section class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <h1 class="text-center mb-4">Magic Link Login</h1>
                <form id="magicLinkForm" class="card shadow p-4" aria-labelledby="magicLinkFormTitle">
                    <h2 id="magicLinkFormTitle" class="visually-hidden">Magic Link Login Form</h2>
                    <div class="mb-3">
                        <label for="email" class="form-label">Enter your Email:</label>
                        <input type="email" id="email" name="email" class="form-control" placeholder="you@example.com" required
                            aria-required="true" aria-describedby="emailHelp">
                        <div id="emailHelp" class="form-text">We'll send you a magic login link.</div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="sendLinkButton" aria-live="polite">
                        <span id="buttonText">Send Login Link</span>
                        <span id="spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
                    </button>
                </form>

                <div id="feedback" class="mt-4 text-center" role="alert" aria-live="assertive"></div>
            </div>
        </section>
    </main>

    <!-- Bootstrap JS (Optional, for enhanced interactivity) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const magicLinkForm = document.getElementById("magicLinkForm");
            const sendLinkButton = document.getElementById("sendLinkButton");
            const buttonText = document.getElementById("buttonText");
            const spinner = document.getElementById("spinner");
            const feedback = document.getElementById("feedback");

            // **IMPORTANT:** Replace this URL with your actual backend API endpoint
            const API_URL = "http://127.0.0.1:8000/api/send-magic-link/"; // For local development
            // const API_URL = "https://api.yourdomain.com/api/send-magic-link/"; // For production

            magicLinkForm.addEventListener("submit", async (event) => {
                event.preventDefault(); // Prevent default form submission

                const emailInput = document.getElementById("email");
                const email = emailInput.value.trim();

                // Reset feedback
                feedback.textContent = "";
                feedback.className = "mt-4 text-center";

                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!email || !emailRegex.test(email)) {
                    feedback.textContent = "Please enter a valid email address.";
                    feedback.classList.add("text-danger");
                    console.warn("Invalid email format entered:", email);
                    return;
                }

                console.log("Valid email entered:", email);
                feedback.textContent = "Sending login link...";
                feedback.classList.add("text-muted");

                // Disable button and show spinner
                sendLinkButton.disabled = true;
                spinner.classList.remove("d-none");
                buttonText.textContent = "Sending...";

                try {
                    // Send request to backend
                    const response = await fetch(API_URL, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ email }),
                    });

                    if (response.ok) {
                        const result = await response.json();
                        feedback.textContent = result.message || "Login link sent successfully!";
                        feedback.classList.remove("text-muted");
                        feedback.classList.add("text-success");
                        console.log("Magic link sent successfully:", result);
                        magicLinkForm.reset(); // Clear the form
                    } else {
                        const errorData = await response.json();
                        feedback.textContent = errorData.message || "Failed to send login link.";
                        feedback.classList.remove("text-muted");
                        feedback.classList.add("text-danger");
                        console.error("Error sending magic link:", errorData);
                    }
                } catch (error) {
                    feedback.textContent = "An error occurred. Please try again later.";
                    feedback.classList.remove("text-muted");
                    feedback.classList.add("text-danger");
                    console.error("Request failed:", error);
                } finally {
                    // Re-enable button and hide spinner
                    sendLinkButton.disabled = false;
                    spinner.classList.add("d-none");
                    buttonText.textContent = "Send Login Link";
                }
            });
        });
    </script>
</body>

</html>
